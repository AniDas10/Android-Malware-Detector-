import argparse
import os
import config
import joblib
import pandas as pd
from sklearn import metrics
from sklearn import tree
import dispatcher


def run(fold, model):
    df = pd.read_csv(config.TRAINING_FILE)

    df = df.drop(columns=['Unnamed: 0.1', 'Description', 'Category'])

    # training data is where kFold is not equal to the fold number
    df_train = df[df.kfold != fold].reset_index(drop=True)

    # validation data is where kfold is equal to the fold number
    df_valid = df[df.kfold == fold].reset_index(drop=True)

    x_train = df_train.drop('Class', axis=1).values
    y_train = df_train.Class.values

    x_valid = df_valid.drop('Class', axis=1).values
    y_valid = df_valid.Class.values


    # lets use a simple tree classifier as our baseline model first
    # we can feature engineer ahead and this would be the baseline we need to improve on
    clf = dispatcher.models[model]

    # fitting out model
    clf.fit(x_train, y_train)

    # creating predictions for validation set
    preds = clf.predict(x_valid)

    # calculating accuracy
    accuracy = metrics.accuracy_score(y_valid, preds)
    print(f'Fold={fold}, Accuracy = {accuracy}')

    # save the model
    joblib.dump(clf, os.path.join(config.MODEL_OUTPUT, f'baseline_dt_{fold}.bin'))


if __name__=='__main__':
    """
    # uncomment this section to simply run train.py and get the models

    run(fold=0, rf)
    run(fold=1, rf)
    run(fold=2, rf)
    run(fold=3, rf)
    run(fold=4, rf)
    """

    # to run it fold wise and assign a specific model to each fold
    # in cmd: python train.py --fold 0 --model decision_tree_gini
    # in cmd: python train.py --fold 1 --model decision_tree_entropy
    # in cmd: python train.py --fold 2 --model rf
    # the available list of model names are prseent in our dispatcher.py file
    # from here we will dispatch all models so it is flexible to change in the future

    parser = argparse.ArgumentParser()

    # now we add the different arguments we need and their type
    parser.add_argument("--fold", type=int)
    parser.add_argument("--model", type=str)

    # read arguments from cmd
    args = parser.parse_args()

    # and now we run it based on args received
    run(fold=args.fold, model=args.model)
